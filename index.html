<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uhrzeit â€“ Umgangssprache (Sprechen)</title>
  <style>
    :root{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
    }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:14px;
    }
    .app{
      background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.1);
      padding:1.6rem 1.4rem; max-width:560px; width:100%; box-sizing:border-box;
    }
    h1{ margin:0 0 .4rem; text-align:center; font-size:1.6rem; }
    .subtitle{ text-align:center; color:#4b5563; margin-bottom:1rem; font-size:.95rem; }
    .hidden{ display:none; }
    .center{ text-align:center; }
    .choice-grid{
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.6rem; margin:.7rem 0 .4rem;
    }
    .choice-btn{
      padding:.9rem .6rem; border-radius:16px; border:2px solid #d1d5db;
      background:#f9fafb; font-size:1rem; font-weight:600; cursor:pointer;
      transition:background .15s, transform .05s, border-color .15s, box-shadow .15s;
    }
    .choice-btn.selected{
      background:#2563eb; color:#fff; border-color:#1d4ed8; box-shadow:0 5px 15px rgba(37,99,235,.35);
    }
    .choice-btn:active{ transform:translateY(1px); }
    .selected-info{
      font-size:.85rem; color:#6b7280; text-align:center; min-height:1.2rem; margin:.2rem 0 .3rem;
    }
    .primary-btn{
      margin-top:.8rem; width:100%; padding:.75rem 1rem; font-size:1.1rem; border-radius:999px;
      border:none; cursor:pointer; background:#2563eb; color:#fff; font-weight:700;
    }
    .primary-btn:hover{ background:#1d4ed8; }
    .primary-btn:disabled{ background:#9ca3af; cursor:not-allowed; }
    .secondary-btn{
      margin-top:.4rem; width:100%; padding:.65rem 1rem; font-size:1rem; border-radius:999px;
      border:1px solid #d1d5db; cursor:pointer; background:#f9fafb; color:#111827; font-weight:600;
    }
    .secondary-btn:hover{ background:#e5e7eb; border-color:#9ca3af; }

    .progress{ text-align:center; color:#6b7280; font-size:.9rem; margin-bottom:.4rem; }
    .tag{ display:inline-block; border-radius:999px; padding:.15rem .6rem; font-size:.8rem; background:#eff6ff; color:#1d4ed8; }
    .clock-wrapper{ display:flex; justify-content:center; margin-top:.6rem; }
    #clock-canvas{ background:#f9fafb; border-radius:50%; box-shadow:inset 0 0 5px rgba(0,0,0,.08); }

    .answer-box{
      margin-top:1rem;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:14px;
      padding:.9rem;
    }
    .equation{ text-align:center; margin:.4rem 0 .2rem; font-size:1.05rem; color:#111827; font-weight:700; }
    .mic-row{ display:grid; grid-template-columns:1fr; gap:.6rem; margin-top:.6rem; }
    @media (min-width:520px){
      .mic-row{ grid-template-columns: 1fr 1fr; }
    }
    .mic-btn{
      width:100%;
      padding:.75rem 1rem;
      font-size:1.05rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:800;
      background:#111827;
      color:#fff;
    }
    .mic-btn.listening{ background:#dc2626; }
    .mic-btn:disabled{ background:#9ca3af; cursor:not-allowed; }
    .input-fallback{
      width:100%;
      padding:.7rem .8rem;
      border-radius:12px;
      border:2px solid #d1d5db;
      background:#fff;
      font-size:1.02rem;
      font-weight:650;
      color:#111827;
      outline:none;
      box-sizing:border-box;
    }
    .input-fallback:focus{ border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }

    .heard{
      margin-top:.6rem;
      font-size:.95rem;
      color:#374151;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:.6rem .7rem;
      min-height:2.2rem;
      word-break:break-word;
    }
    .hint{ font-size:.85rem; color:#6b7280; margin-top:.5rem; line-height:1.35; }
    .feedback{ min-height:1.4rem; margin-top:.6rem; font-weight:750; text-align:center; }
    .feedback.ok{ color:#15803d; }
    .feedback.error{ color:#b91c1c; }

    .stats{ margin-top:.9rem; font-size:.95rem; color:#374151; }
    .small-note{ font-size:.85rem; color:#6b7280; margin-top:.4rem; }
    .badge{
      display:inline-block; padding:.15rem .55rem; border-radius:999px;
      font-size:.78rem; border:1px solid #e5e7eb; background:#fff; color:#374151;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Wie spÃ¤t ist es?</h1>
  <div class="subtitle">
    Lies die analoge Uhr und <strong>sage</strong> die Uhrzeit in Umgangssprache.<br>
    Beispiele: â€žViertel vor Zehnâ€œ, â€žFÃ¼nf nach Zweiâ€œ, â€žHalb Neunâ€œ, â€žEin Uhrâ€œ.
  </div>

  <!-- START -->
  <div id="start-screen">
    <div class="center">
      <p>Bitte eine <strong>Klasse</strong> und eine <strong>Schwierigkeit</strong> auswÃ¤hlen.</p>
    </div>

    <div class="center" style="margin-top:.5rem;">Klasse</div>
    <div class="choice-grid" id="grade-grid">
      <button type="button" class="choice-btn grade-btn" data-grade="2">2. Klasse</button>
      <button type="button" class="choice-btn grade-btn" data-grade="3">3. Klasse</button>
    </div>

    <div class="center" style="margin-top:1rem;">Schwierigkeit</div>
    <div class="choice-grid" id="difficulty-grid">
      <button type="button" class="choice-btn difficulty-btn" data-diff="easy">einfach</button>
      <button type="button" class="choice-btn difficulty-btn" data-diff="hard">schwierig</button>
    </div>

    <div class="selected-info" id="selected-info"></div>
    <button class="primary-btn" id="start-btn" disabled>Los!</button>

    <div class="small-note center" id="sr-note"></div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-screen" class="hidden">
    <div class="progress" id="progress-text"></div>
    <div class="center">
      <span class="tag" id="variant-label"></span>
      <div class="equation">Sage die passende Uhrzeit:</div>
      <div class="small-note"><span class="badge">Tipp</span> Es reicht, wenn die richtige LÃ¶sung <strong>im Gesagten enthalten</strong> ist (z.B. â€žâ€¦ viertel vor zehn â€¦â€œ).</div>
    </div>

    <div class="clock-wrapper">
      <canvas id="clock-canvas" width="220" height="220"></canvas>
    </div>

    <div class="answer-box">
      <div class="mic-row">
        <button class="mic-btn" id="mic-btn">ðŸŽ¤ Sprechen</button>
        <button class="secondary-btn" id="check-btn" style="margin-top:0;">ÃœberprÃ¼fen</button>
      </div>

      <!-- Fallback (wenn SR nicht verfÃ¼gbar) -->
      <div id="fallback-wrap" class="hidden" style="margin-top:.6rem;">
        <input id="fallback-input" class="input-fallback" placeholder="Falls Sprechen nicht geht: hier eintippen (z.B. viertel vor zehn)" />
        <div class="hint">Browser ohne Spracherkennung: tippe die Antwort. (Empfohlen: Chrome/Edge)</div>
      </div>

      <div class="heard" id="heard">Erkannt: â€”</div>
      <div class="feedback" id="feedback"></div>
      <div class="hint" id="expected-hint"></div>
    </div>

    <div class="stats">
      Richtig: <span id="stat-correct">0</span> / <span id="stat-total">30</span><br>
      Falsche Versuche: <span id="stat-wrong">0</span><br>
      Modus: <span id="stat-mode"></span>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result-screen" class="hidden center">
    <h2>Fertig! ðŸŽ‰</h2>
    <p id="result-summary"></p>
    <p style="margin-top:.8rem; font-size:.9rem; color:#4b5563;">
      Wenn du fertig bist, klicke auf <strong>â€žFertigâ€œ</strong>, damit LearningView den Auftrag als erledigt markiert.<br>
      Oder klicke auf <strong>â€žWeiter Ã¼benâ€œ</strong>, um zur Auswahl zurÃ¼ckzukehren.
    </p>
    <button class="primary-btn" id="finish-btn">Fertig</button>
    <button class="secondary-btn" id="restart-btn">Weiter Ã¼ben</button>
  </div>
</div>

<script>
  const TOTAL_QUESTIONS = 30;

  const GRADE_LABELS = { 2: "2. Klasse", 3: "3. Klasse" };
  const DIFF_LABELS = { easy: "einfach", hard: "schwierig" };

  let selectedGrade = null;       // 2|3
  let selectedDifficulty = null;  // easy|hard

  let questionsDone = 0;
  let correctAnswers = 0;
  let wrongAnswers = 0;
  let usedQuestions = [];

  // currentQuestion: {hour, minute, label, correctSet:Set<string>, canonical:string, acceptedPhrases:string[]}
  let currentQuestion = null;

  // DOM
  const startScreen = document.getElementById("start-screen");
  const quizScreen = document.getElementById("quiz-screen");
  const resultScreen = document.getElementById("result-screen");

  const gradeGrid = document.getElementById("grade-grid");
  const difficultyGrid = document.getElementById("difficulty-grid");
  const selectedInfo = document.getElementById("selected-info");
  const startBtn = document.getElementById("start-btn");
  const srNote = document.getElementById("sr-note");

  const progressText = document.getElementById("progress-text");
  const variantLabel = document.getElementById("variant-label");
  const feedback = document.getElementById("feedback");
  const heardEl = document.getElementById("heard");
  const expectedHint = document.getElementById("expected-hint");

  const statCorrect = document.getElementById("stat-correct");
  const statTotal = document.getElementById("stat-total");
  const statWrong = document.getElementById("stat-wrong");
  const statMode = document.getElementById("stat-mode");

  const restartBtn = document.getElementById("restart-btn");
  const finishBtn = document.getElementById("finish-btn");
  const resultSummary = document.getElementById("result-summary");

  const micBtn = document.getElementById("mic-btn");
  const checkBtn = document.getElementById("check-btn");

  const fallbackWrap = document.getElementById("fallback-wrap");
  const fallbackInput = document.getElementById("fallback-input");

  const clockCanvas = document.getElementById("clock-canvas");
  const clockCtx = clockCanvas.getContext("2d");

  // ------------------------
  // SpeechRecognition setup
  // ------------------------
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognizer = null;
  let isListening = false;
  let lastTranscriptRaw = "";

  function setupSpeechRecognition(){
    if(!SR){
      recognizer = null;
      micBtn.disabled = true;
      micBtn.textContent = "ðŸŽ¤ Nicht verfÃ¼gbar";
      fallbackWrap.classList.remove("hidden");
      srNote.textContent = "Hinweis: Spracherkennung funktioniert am zuverlÃ¤ssigsten in Chrome/Edge.";
      return;
    }
    recognizer = new SR();
    recognizer.lang = "de-CH";          // de-CH passt gut fÃ¼r CH-Klasse (bei Bedarf de-DE)
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;
    recognizer.continuous = false;

    recognizer.onstart = () => {
      isListening = true;
      micBtn.classList.add("listening");
      micBtn.textContent = "â¹ Stop";
      feedback.textContent = "";
      feedback.className = "feedback";
      heardEl.textContent = "Erkannt: â€¦";
    };

    recognizer.onend = () => {
      isListening = false;
      micBtn.classList.remove("listening");
      micBtn.textContent = "ðŸŽ¤ Sprechen";
    };

    recognizer.onerror = (e) => {
      // typisches: "no-speech", "not-allowed", "audio-capture"
      feedback.textContent = "Sprach-Fehler: " + (e.error || "unbekannt");
      feedback.className = "feedback error";
      fallbackWrap.classList.remove("hidden");
    };

    recognizer.onresult = (e) => {
      const t = e.results?.[0]?.[0]?.transcript || "";
      lastTranscriptRaw = t;
      heardEl.textContent = "Erkannt: " + (t || "â€”");
      // nach Erkennung kannst du direkt prÃ¼fen (optional). Wir lassen es bewusst manuell Ã¼ber "ÃœberprÃ¼fen".
    };

    srNote.textContent = "Hinweis: Mikrofon-Berechtigung nÃ¶tig. Starte mit Klick auf â€žSprechenâ€œ.";
  }

  micBtn.addEventListener("click", () => {
    if(!recognizer){
      fallbackWrap.classList.remove("hidden");
      return;
    }
    if(isListening){
      try{ recognizer.stop(); }catch(_){}
      return;
    }
    try{
      lastTranscriptRaw = "";
      recognizer.start();
    }catch(err){
      // manchmal wirft start() eine Exception, wenn zu schnell hintereinander
      feedback.textContent = "Bitte kurz warten und nochmals auf â€žSprechenâ€œ klicken.";
      feedback.className = "feedback error";
    }
  });

  // ------------------------
  // Helpers
  // ------------------------
  function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randomIntStep(min, max, step){
    const count = Math.floor((max-min)/step)+1;
    return min + randomInt(0, count-1)*step;
  }
  function capFirst(s){ return s ? (s.charAt(0).toUpperCase()+s.slice(1)) : s; }

  function hourToWord(h){
    const map = {1:"eins",2:"zwei",3:"drei",4:"vier",5:"fÃ¼nf",6:"sechs",7:"sieben",8:"acht",9:"neun",10:"zehn",11:"elf",12:"zwÃ¶lf"};
    return map[h] || String(h);
  }
  function hourToWordEin(h){ return h === 1 ? "ein" : hourToWord(h); }

  // Normalisierung: klein, umlaute stabil, sonderzeichen weg, multiple spaces
  function normalizeText(s){
    s = (s || "").toLowerCase();

    // hÃ¤ufige Einleitungen entfernen / egal machen (wir matchen trotzdem per contains)
    // Wir lassen sie drin â€“ contains wird dadurch nicht gestÃ¶rt.

    // Zahlen (1-12) im Text zu Worten machen (falls SpeechRecognition "10" liefert)
    const numMap = {
      "1":"eins","2":"zwei","3":"drei","4":"vier","5":"fÃ¼nf","6":"sechs","7":"sieben","8":"acht","9":"neun","10":"zehn","11":"elf","12":"zwÃ¶lf",
      "15":"viertel","20":"zwanzig"
    };
    // zuerst 10-12, 15, 20, 11, 12 etc. durch Regex mit Wordboundaries
    const nums = ["20","15","12","11","10","9","8","7","6","5","4","3","2","1"];
    for(const n of nums){
      s = s.replace(new RegExp(`\\b${n}\\b`, "g"), numMap[n] || n);
    }

    // Satzzeichen raus, alles auf spaces
    s = s.replace(/[^\p{L}\p{N}\s]/gu, " ");
    s = s.replace(/\s+/g, " ").trim();
    return s;
  }

  // Match: richtige LÃ¶sung muss im Gesagten enthalten sein.
  // Wir nutzen Word-boundary-ish Matching (per " (phrase) " in gepaddetem String),
  // damit "zehn" nicht in "zehntel" matcht.
  function containsPhrase(heardNorm, phraseNorm){
    const H = " " + heardNorm + " ";
    const P = " " + phraseNorm + " ";
    return H.includes(P);
  }

  // Generiert zusÃ¤tzliche erlaubte Varianten:
  // - erlaubt auch "... uhr" am Ende (bei nicht-0 Minuten)
  // - bei voller Stunde: akzeptiert "ein", "eins", "ein uhr", "eins uhr"
  function expandAccepted(set){
    const out = new Set();
    for(const p of set){
      out.add(p);
      out.add(p + " uhr");
      // falls Kind "... uh" oder "uhr" weglÃ¤sst, sind wir eh bei p selbst.
    }

    // Spezial: volle Stunde
    // Wenn Set "ein uhr" enthÃ¤lt, akzeptiere auch "ein" und "eins" usw.
    for(const p of Array.from(out)){
      if(p.endsWith(" uhr")){
        const base = p.slice(0, -4).trim();
        out.add(base);
      }
    }
    // Extra: eins/ein austausch
    const extras = new Set();
    out.forEach(p => {
      extras.add(p.replace(/\beins\b/g, "ein"));
      extras.add(p.replace(/\bein\b/g, "eins"));
    });
    extras.forEach(x => out.add(x));

    return Array.from(out).map(normalizeText);
  }

  // ------------------------
  // Startauswahl
  // ------------------------
  gradeGrid.querySelectorAll(".grade-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const g = Number(btn.dataset.grade);
      selectedGrade = (selectedGrade === g) ? null : g;
      gradeGrid.querySelectorAll(".grade-btn").forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.grade) === selectedGrade);
      });
      updateStartControls();
    });
  });

  difficultyGrid.querySelectorAll(".difficulty-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d = btn.dataset.diff;
      selectedDifficulty = (selectedDifficulty === d) ? null : d;
      difficultyGrid.querySelectorAll(".difficulty-btn").forEach(b=>{
        b.classList.toggle("selected", b.dataset.diff === selectedDifficulty);
      });
      updateStartControls();
    });
  });

  function updateStartControls(){
    if(!selectedGrade && !selectedDifficulty){
      selectedInfo.textContent = "Keine Klasse und Schwierigkeit ausgewÃ¤hlt.";
      startBtn.disabled = true; return;
    }
    if(!selectedGrade){
      selectedInfo.textContent = "Bitte eine Klasse auswÃ¤hlen.";
      startBtn.disabled = true; return;
    }
    if(!selectedDifficulty){
      selectedInfo.textContent = "Bitte eine Schwierigkeit auswÃ¤hlen.";
      startBtn.disabled = true; return;
    }
    selectedInfo.textContent = "AusgewÃ¤hlt: " + GRADE_LABELS[selectedGrade] + ", " + DIFF_LABELS[selectedDifficulty];
    startBtn.disabled = false;
  }

  startBtn.addEventListener("click", startTraining);

  restartBtn.addEventListener("click", ()=>{
    quizScreen.classList.add("hidden");
    resultScreen.classList.add("hidden");
    startScreen.classList.remove("hidden");
  });

  // LearningView feedback
  finishBtn.addEventListener("click", ()=>{
    finishBtn.disabled = true;
    finishBtn.textContent = "Erledigt âœ”";
    try{
      if(window.parent && window.parent !== window){
        window.parent.postMessage("AppSolved","*");
      }
    }catch(e){
      console.warn("LearningView-RÃ¼ckmeldung nicht mÃ¶glich:", e);
    }
  });

  checkBtn.addEventListener("click", checkAnswer);
  fallbackInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      checkAnswer();
    }
  });

  function startTraining(){
    if(!selectedGrade || !selectedDifficulty) return;

    questionsDone = 0;
    correctAnswers = 0;
    wrongAnswers = 0;
    usedQuestions = [];

    statCorrect.textContent = "0";
    statWrong.textContent = "0";
    statTotal.textContent = String(TOTAL_QUESTIONS);
    statMode.textContent = `${GRADE_LABELS[selectedGrade]} â€“ ${DIFF_LABELS[selectedDifficulty]}`;

    feedback.textContent = "";
    feedback.className = "feedback";
    heardEl.textContent = "Erkannt: â€”";
    expectedHint.textContent = "";

    startScreen.classList.add("hidden");
    resultScreen.classList.add("hidden");
    quizScreen.classList.remove("hidden");

    newQuestion();
  }

  function newQuestion(){
    feedback.textContent = "";
    feedback.className = "feedback";
    lastTranscriptRaw = "";
    fallbackInput.value = "";
    heardEl.textContent = "Erkannt: â€”";

    let q, tries = 0;
    while(true){
      q = generateTimeQuestion(selectedGrade, selectedDifficulty);
      const key = `${q.hour}-${q.minute}-${selectedGrade}-${selectedDifficulty}`;
      if(!usedQuestions.includes(key)){
        usedQuestions.push(key);
        break;
      }
      if(++tries > 400) break;
    }

    currentQuestion = q;
    variantLabel.textContent = q.label;

    drawClock(q.hour, q.minute);
    progressText.textContent = `Aufgabe ${questionsDone + 1} von ${TOTAL_QUESTIONS}`;

    // kleine Hilfestellung (nicht zu verrÃ¤terisch, aber hilfreich)
    expectedHint.textContent = "Sprich z.B.: â€žEs ist " + q.canonical.toLowerCase().replace(/\buhr\b/g,"").trim() + "â€œ";
  }

  function checkAnswer(){
    if(!currentQuestion) return;

    const heardRaw = (lastTranscriptRaw || "").trim();
    const typedRaw = (fallbackInput.value || "").trim();

    const usedText = heardRaw || typedRaw;

    if(!usedText){
      feedback.textContent = "Bitte zuerst sprechen (oder eintippen) und dann Ã¼berprÃ¼fen.";
      feedback.className = "feedback error";
      return;
    }

    const heardNorm = normalizeText(usedText);

    // PrÃ¼fen: richtige LÃ¶sung muss enthalten sein
    let ok = false;
    let matched = "";

    for(const phrase of currentQuestion.acceptedPhrases){
      const p = normalizeText(phrase);
      if(containsPhrase(heardNorm, p)){
        ok = true;
        matched = phrase;
        break;
      }
    }

    if(ok){
      correctAnswers++;
      statCorrect.textContent = String(correctAnswers);
      feedback.textContent = "Richtig! ðŸ‘";
      feedback.className = "feedback ok";
    }else{
      wrongAnswers++;
      statWrong.textContent = String(wrongAnswers);
      feedback.textContent = "Leider falsch. Beispiel richtig: " + currentQuestion.canonical;
      feedback.className = "feedback error";
    }

    questionsDone++;
    if(questionsDone >= TOTAL_QUESTIONS){
      setTimeout(endTraining, 700);
    }else{
      setTimeout(newQuestion, 700);
    }
  }

  function endTraining(){
    quizScreen.classList.add("hidden");
    resultScreen.classList.remove("hidden");

    const quote = (correctAnswers / TOTAL_QUESTIONS * 100).toFixed(0);
    const modeText = `${GRADE_LABELS[selectedGrade]}, ${DIFF_LABELS[selectedDifficulty]}`;

    resultSummary.innerHTML =
      `Du hast <strong>${TOTAL_QUESTIONS}</strong> Uhrzeiten im Modus <strong>${modeText}</strong> gelÃ¶st.<br>` +
      `Davon waren <strong>${correctAnswers}</strong> richtig (<strong>${quote}%</strong>).<br>` +
      `Du hattest insgesamt <strong>${wrongAnswers}</strong> falsche Versuche.`;
  }

  // ------------------------
  // Aufgabengenerator
  // ------------------------
  function generateTimeQuestion(grade, difficulty){
    let hour, minute, label;

    if(grade === 2){
      if(difficulty === "easy"){
        hour = randomInt(1,12);
        minute = Math.random() < 0.5 ? 0 : 30;
        label = "Volle und halbe Stunden";
      }else{
        const minuteChoices = [0,10,15,20,30,40,45,50];
        hour = randomInt(1,12);
        minute = minuteChoices[randomInt(0, minuteChoices.length-1)];
        label = "10-Minuten & Viertel";
      }
    }else{
      hour = randomInt(1,12);
      minute = randomIntStep(0,55,5);
      label = (difficulty === "easy") ? "5-Minuten-Schritte" : "5-Minuten-Schritte (Mix)";
    }

    const forms = timeToForms(hour, minute);
    const acceptedPhrases = expandAccepted(forms.set);

    return {
      hour, minute, label,
      correctSet: forms.set,
      canonical: forms.canonical,
      acceptedPhrases
    };
  }

  // Erlaubte Formen (wie dein Dropdown-Set, aber jetzt fÃ¼r "contains"-Matching):
  // - "<ein> uhr"
  // - "halb <nÃ¤chsteStunde>"
  // - "fÃ¼nf/zehn/viertel/zwanzig nach/vor <stunde>"
  // - "fÃ¼nf vor halb <nÃ¤chsteStunde>" / "fÃ¼nf nach halb <nÃ¤chsteStunde>"
  function timeToForms(hour, minute){
    const h = ((hour - 1) % 12) + 1;
    const nextH = (h % 12) + 1;

    const hourWord = hourToWord(h);
    const nextHourWord = hourToWord(nextH);

    const set = new Set();
    let canonical = "";

    function add(s){
      const t = normalizeText(s);
      set.add(t);
      if(!canonical) canonical = capFirst(t);
    }

    if(minute === 0){
      add(`${hourToWordEin(h)} uhr`);
      return { set, canonical };
    }

    switch(minute){
      case 5:  add(`fÃ¼nf nach ${hourWord}`); break;
      case 10: add(`zehn nach ${hourWord}`); break;
      case 15: add(`viertel nach ${hourWord}`); break;
      case 20: add(`zwanzig nach ${hourWord}`); break;

      case 25: add(`fÃ¼nf vor halb ${nextHourWord}`); break;
      case 30: add(`halb ${nextHourWord}`); break;
      case 35: add(`fÃ¼nf nach halb ${nextHourWord}`); break;

      case 40: add(`zwanzig vor ${nextHourWord}`); break;
      case 45: add(`viertel vor ${nextHourWord}`); break;
      case 50: add(`zehn vor ${nextHourWord}`); break;
      case 55: add(`fÃ¼nf vor ${nextHourWord}`); break;

      default:
        // FÃ¼r 5er-Schritte, die nicht in deinem Umgangssprache-Vokabular sind,
        // kÃ¶nnten wir erweitern â€“ aber wir bleiben strikt bei den bekannten Formen.
        add(`${hourToWordEin(h)} uhr`);
    }

    return { set, canonical };
  }

  // ------------------------
  // Analoge Uhr zeichnen
  // ------------------------
  function drawClock(hour, minute){
    const ctx = clockCtx;
    const w = clockCanvas.width;
    const h = clockCanvas.height;
    const radius = Math.min(w,h)/2 - 10;
    const cx = w/2;
    const cy = h/2;

    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.translate(cx,cy);

    // Kreis
    ctx.beginPath();
    ctx.arc(0,0,radius,0,Math.PI*2);
    ctx.fillStyle="#ffffff";
    ctx.fill();
    ctx.lineWidth=3;
    ctx.strokeStyle="#111827";
    ctx.stroke();

    // Striche
    for(let i=0;i<12;i++){
      const angle = (Math.PI/6)*i - Math.PI/2;
      const inner = radius - 10;
      const outer = radius - (i%3===0 ? 18 : 14);
      ctx.beginPath();
      ctx.moveTo(inner*Math.cos(angle), inner*Math.sin(angle));
      ctx.lineTo(outer*Math.cos(angle), outer*Math.sin(angle));
      ctx.lineWidth = (i%3===0)?3:1.5;
      ctx.strokeStyle="#111827";
      ctx.stroke();
    }

    // Mittelpunkt
    ctx.beginPath();
    ctx.arc(0,0,4,0,Math.PI*2);
    ctx.fillStyle="#111827";
    ctx.fill();

    // Minutenzeiger
    const minuteAngle = (Math.PI/30)*minute - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((radius-22)*Math.cos(minuteAngle), (radius-22)*Math.sin(minuteAngle));
    ctx.lineWidth=3;
    ctx.strokeStyle="#1f2937";
    ctx.stroke();

    // Stundenzeiger
    const hourIn12 = hour % 12;
    const hourAngle = (Math.PI/6)*(hourIn12 + minute/60) - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((radius-45)*Math.cos(hourAngle), (radius-45)*Math.sin(hourAngle));
    ctx.lineWidth=4;
    ctx.strokeStyle="#111827";
    ctx.stroke();

    ctx.restore();
  }

  // init
  (function init(){
    statTotal.textContent = String(TOTAL_QUESTIONS);
    updateStartControls();
    drawClock(12,0);
    setupSpeechRecognition();
  })();
</script>
</body>
</html>
