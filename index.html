<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uhrzeit ‚Äì Umgangssprache (Sprechen)</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f3f4f6;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px;}
    .app{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:1.6rem 1.4rem;max-width:620px;width:100%;box-sizing:border-box;}
    h1{margin:0 0 .4rem;text-align:center;font-size:1.6rem;}
    .subtitle{text-align:center;color:#4b5563;margin-bottom:1rem;font-size:.95rem;line-height:1.35;}
    .hidden{display:none;}
    .center{text-align:center;}
    .choice-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.6rem;margin:.7rem 0 .4rem;}
    .choice-btn{padding:.9rem .6rem;border-radius:16px;border:2px solid #d1d5db;background:#f9fafb;font-size:1rem;font-weight:650;cursor:pointer;}
    .choice-btn.selected{background:#2563eb;color:#fff;border-color:#1d4ed8;box-shadow:0 5px 15px rgba(37,99,235,.35);}
    .selected-info{font-size:.85rem;color:#6b7280;text-align:center;min-height:1.2rem;margin:.2rem 0 .3rem;}
    .primary-btn{margin-top:.8rem;width:100%;padding:.75rem 1rem;font-size:1.1rem;border:none;border-radius:999px;cursor:pointer;background:#2563eb;color:#fff;font-weight:800;}
    .primary-btn:disabled{background:#9ca3af;cursor:not-allowed;}
    .secondary-btn{margin-top:.4rem;width:100%;padding:.65rem 1rem;font-size:1rem;border-radius:999px;border:1px solid #d1d5db;cursor:pointer;background:#f9fafb;color:#111827;font-weight:700;}
    .progress{text-align:center;color:#6b7280;font-size:.9rem;margin-bottom:.4rem;}
    .tag{display:inline-block;border-radius:999px;padding:.15rem .6rem;font-size:.8rem;background:#eff6ff;color:#1d4ed8;}
    .clock-wrapper{display:flex;justify-content:center;margin-top:.6rem;}
    #clock-canvas{background:#f9fafb;border-radius:50%;box-shadow:inset 0 0 5px rgba(0,0,0,.08);}
    .answer-box{margin-top:1rem;border:1px solid #e5e7eb;background:#f9fafb;border-radius:14px;padding:.9rem;}
    .equation{text-align:center;margin:.4rem 0 .2rem;font-size:1.05rem;color:#111827;font-weight:900;}
    .mic-row{display:grid;grid-template-columns:1fr;gap:.6rem;margin-top:.6rem;}
    @media (min-width:520px){.mic-row{grid-template-columns:1fr 1fr;}}
    .mic-btn{width:100%;padding:.75rem 1rem;font-size:1.05rem;border-radius:999px;border:none;cursor:pointer;font-weight:900;background:#111827;color:#fff;}
    .mic-btn.listening{background:#dc2626;}
    .mic-btn:disabled{background:#9ca3af;cursor:not-allowed;}
    .input-fallback{width:100%;padding:.7rem .8rem;border-radius:12px;border:2px solid #d1d5db;background:#fff;font-size:1.02rem;font-weight:700;color:#111827;outline:none;box-sizing:border-box;}
    .heard{margin-top:.6rem;font-size:1.02rem;color:#111827;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem .8rem;min-height:2.2rem;word-break:break-word;font-weight:850;}
    .hint{font-size:.85rem;color:#6b7280;margin-top:.5rem;line-height:1.35;}
    .feedback{min-height:1.4rem;margin-top:.6rem;font-weight:900;text-align:center;}
    .feedback.ok{color:#15803d;}
    .feedback.error{color:#b91c1c;}
    .stats{margin-top:.9rem;font-size:.95rem;color:#374151;}
    .badge{display:inline-block;padding:.15rem .55rem;border-radius:999px;font-size:.78rem;border:1px solid #e5e7eb;background:#fff;color:#374151;}
  </style>
</head>
<body>
<div class="app">
  <h1>Wie sp√§t ist es?</h1>
  <div class="subtitle">
    Lies die analoge Uhr und sage die Uhrzeit in <strong>Umgangssprache</strong>.<br>
    Gepr√ºft wird exakt ein Ausdruck aus: <span class="badge">punkt</span>,
    <span class="badge">f√ºnf/zehn/viertel/zwanzig nach</span>,
    <span class="badge">f√ºnf vor halb</span>, <span class="badge">halb</span>, <span class="badge">f√ºnf nach halb</span>,
    <span class="badge">zwanzig/viertel/zehn/f√ºnf vor</span> + <span class="badge">eins..zw√∂lf</span>.
  </div>

  <!-- START -->
  <div id="start-screen">
    <div class="center"><p>Bitte eine <strong>Klasse</strong> und eine <strong>Schwierigkeit</strong> ausw√§hlen.</p></div>
    <div class="center" style="margin-top:.5rem;">Klasse</div>
    <div class="choice-grid" id="grade-grid">
      <button type="button" class="choice-btn grade-btn" data-grade="2">2. Klasse</button>
      <button type="button" class="choice-btn grade-btn" data-grade="3">3. Klasse</button>
    </div>

    <div class="center" style="margin-top:1rem;">Schwierigkeit</div>
    <div class="choice-grid" id="difficulty-grid">
      <button type="button" class="choice-btn difficulty-btn" data-diff="easy">einfach</button>
      <button type="button" class="choice-btn difficulty-btn" data-diff="hard">schwierig</button>
    </div>

    <div class="selected-info" id="selected-info"></div>
    <button class="primary-btn" id="start-btn" disabled>Los!</button>
    <div class="hint center" id="sr-note"></div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-screen" class="hidden">
    <div class="progress" id="progress-text"></div>
    <div class="center">
      <span class="tag" id="variant-label"></span>
      <div class="equation">Sage die passende Uhrzeit:</div>
      <div class="hint"><span class="badge">Regel</span> Anzeige & Pr√ºfung: <strong>nur Umgangssprache</strong> (keine Zahlzeit).</div>
    </div>

    <div class="clock-wrapper">
      <canvas id="clock-canvas" width="240" height="240"></canvas>
    </div>

    <div class="answer-box">
      <div class="mic-row">
        <button class="mic-btn" id="mic-btn">üé§ Sprechen</button>
        <button class="secondary-btn" id="check-btn" style="margin-top:0;">√úberpr√ºfen</button>
      </div>

      <div id="fallback-wrap" class="hidden" style="margin-top:.6rem;">
        <input id="fallback-input" class="input-fallback" placeholder="Falls Sprechen nicht geht: z.B. ‚Äûf√ºnf nach halb sieben‚Äú oder ‚Äû5 nach 06:30‚Äú" />
        <div class="hint">Browser ohne Spracherkennung: tippe. (Chrome/Edge empfohlen)</div>
      </div>

      <div class="heard" id="heard-ui">Umgangssprache: ‚Äî</div>
      <div class="feedback" id="feedback"></div>
      <div class="hint" id="expected-hint"></div>
    </div>

    <div class="stats">
      Richtig: <span id="stat-correct">0</span> / <span id="stat-total">30</span><br>
      Falsche Versuche: <span id="stat-wrong">0</span><br>
      Modus: <span id="stat-mode"></span>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result-screen" class="hidden center">
    <h2>Fertig! üéâ</h2>
    <p id="result-summary"></p>
    <p style="margin-top:.8rem; font-size:.9rem; color:#4b5563;">
      Wenn du fertig bist, klicke auf <strong>‚ÄûFertig‚Äú</strong>, damit LearningView den Auftrag als erledigt markiert.
    </p>
    <button class="primary-btn" id="finish-btn">Fertig</button>
    <button class="secondary-btn" id="restart-btn">Weiter √ºben</button>
  </div>
</div>

<script>
/* ==========================
   KONFIG / STATE
========================== */
const TOTAL_QUESTIONS = 30;
const GRADE_LABELS = {2:"2. Klasse",3:"3. Klasse"};
const DIFF_LABELS  = {easy:"einfach",hard:"schwierig"};
const SUPPORTED_MINUTES = [0,5,10,15,20,25,30,35,40,45,50,55];

const PREFIXES = [
  "punkt",
  "f√ºnf nach","zehn nach","viertel nach","zwanzig nach",
  "f√ºnf vor halb","halb","f√ºnf nach halb",
  "zwanzig vor","viertel vor","zehn vor","f√ºnf vor"
];
const HOURS = ["eins","zwei","drei","vier","f√ºnf","sechs","sieben","acht","neun","zehn","elf","zw√∂lf"];

let selectedGrade=null, selectedDifficulty=null;
let questionsDone=0, correctAnswers=0, wrongAnswers=0;
let usedQuestions=[];
let currentQuestion=null;

let lastColloquial=""; // DAS ist die einzige Antwort, die angezeigt & gepr√ºft wird

/* ==========================
   DOM
========================== */
const startScreen = document.getElementById("start-screen");
const quizScreen = document.getElementById("quiz-screen");
const resultScreen = document.getElementById("result-screen");

const gradeGrid = document.getElementById("grade-grid");
const difficultyGrid = document.getElementById("difficulty-grid");
const selectedInfo = document.getElementById("selected-info");
const startBtn = document.getElementById("start-btn");
const srNote = document.getElementById("sr-note");

const progressText = document.getElementById("progress-text");
const variantLabel = document.getElementById("variant-label");
const heardUI = document.getElementById("heard-ui");
const feedback = document.getElementById("feedback");
const expectedHint = document.getElementById("expected-hint");

const statCorrect = document.getElementById("stat-correct");
const statTotal = document.getElementById("stat-total");
const statWrong = document.getElementById("stat-wrong");
const statMode = document.getElementById("stat-mode");

const restartBtn = document.getElementById("restart-btn");
const finishBtn = document.getElementById("finish-btn");
const resultSummary = document.getElementById("result-summary");

const micBtn = document.getElementById("mic-btn");
const checkBtn = document.getElementById("check-btn");
const fallbackWrap = document.getElementById("fallback-wrap");
const fallbackInput = document.getElementById("fallback-input");

const clockCanvas = document.getElementById("clock-canvas");
const clockCtx = clockCanvas.getContext("2d");

/* ==========================
   HELPER BASICS
========================== */
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function clamp12(h){ return ((h-1)%12)+1; }

function hourToWord(h){
  const map={1:"eins",2:"zwei",3:"drei",4:"vier",5:"f√ºnf",6:"sechs",7:"sieben",8:"acht",9:"neun",10:"zehn",11:"elf",12:"zw√∂lf"};
  return map[h] || String(h);
}
function numberToGerman(n){
  const ones=["null","eins","zwei","drei","vier","f√ºnf","sechs","sieben","acht","neun"];
  const special={10:"zehn",11:"elf",12:"zw√∂lf",13:"dreizehn",14:"vierzehn",15:"f√ºnfzehn",16:"sechzehn",17:"siebzehn",18:"achtzehn",19:"neunzehn"};
  if(n>=0 && n<=9) return ones[n];
  if(n>=10 && n<=19) return special[n];
  const tensMap={20:"zwanzig",30:"drei√üig",40:"vierzig",50:"f√ºnfzig"};
  const tens=Math.floor(n/10)*10, one=n%10;
  if(one===0) return tensMap[tens] || String(n);
  const oneWord = (one===1) ? "ein" : ones[one];
  return oneWord + "und" + (tensMap[tens] || String(tens));
}

/* ==========================
   ZEIT -> UMGANGSSPRACHE
========================== */
function timeToColloquial(hour, minute){
  const h = clamp12(hour);
  const next = (h%12)+1;
  const hw = hourToWord(h);
  const nhw = hourToWord(next);
  switch(minute){
    case 0:  return `punkt ${hw}`;
    case 5:  return `f√ºnf nach ${hw}`;
    case 10: return `zehn nach ${hw}`;
    case 15: return `viertel nach ${hw}`;
    case 20: return `zwanzig nach ${hw}`;
    case 25: return `f√ºnf vor halb ${nhw}`;
    case 30: return `halb ${nhw}`;
    case 35: return `f√ºnf nach halb ${nhw}`;
    case 40: return `zwanzig vor ${nhw}`;
    case 45: return `viertel vor ${nhw}`;
    case 50: return `zehn vor ${nhw}`;
    case 55: return `f√ºnf vor ${nhw}`;
    default: return `punkt ${hw}`;
  }
}

/* ==========================
   PARSER: ROH -> (nur) erlaubter Ausdruck
   1) Direkt: Prefix+Stunde (inkl. "f√ºnf vor halb sieben")
   2) Offset+Basiszeit:
      "5 nach 06:30" => 06:35 => "f√ºnf nach halb sieben"
      "5 vor 06:30"  => 06:25 => "f√ºnf vor halb sieben"
   3) Nur hh:mm => map
   4) Nur Stunde => punkt Stunde
========================== */
function normalizeRaw(raw){
  raw = (raw||"").toLowerCase();

  // typisches Zeug
  raw = raw
    .replace(/\bviertal\b/g,"viertel")
    .replace(/\bviertl\b/g,"viertel")
    .replace(/\bvorhalb\b/g,"vor halb")
    .replace(/\bnachhalb\b/g,"nach halb")
    .replace(/\bfuenf\b/g,"f√ºnf")
    .replace(/\bzwolf\b/g,"zw√∂lf")
    .replace(/\bdreissig\b/g,"drei√üig");

  // "5." => "5"
  raw = raw.replace(/\b(\d{1,2})\./g, "$1");

  // "uhr" etc raus
  raw = raw
    .replace(/\bes\s+ist\b/g," ")
    .replace(/\bdas\s+ist\b/g," ")
    .replace(/\bjetzt\b/g," ")
    .replace(/\bbitte\b/g," ")
    .replace(/\buhr\b/g," ")
    .replace(/\s+/g," ")
    .trim();

  // digits einzeln -> w√∂rter (f√ºr "5 vor halb 4")
  raw = raw.replace(/\b(\d{1,2})\b/g, (_,d)=>numberToGerman(parseInt(d,10)));

  // nur buchstaben/spaces/:/.
  raw = raw.replace(/[^\p{L}\s:.\d]/gu," ").replace(/\s+/g," ").trim();

  // "ein" als stunde => "eins" (nur f√ºrs matching)
  raw = raw.replace(/\bein\b/g,"eins");
  return raw;
}

function parseTimeToken(clean){
  const m = clean.match(/\b([0-2]?\d)\s*[:.]\s*([0-5]\d)\b/);
  if(!m) return null;
  let hh = parseInt(m[1],10);
  let mm = parseInt(m[2],10);
  if(!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  if(hh===0) hh=12;
  hh = clamp12(hh);
  return {hour: hh, minute: mm};
}

function parseOffsetToken(clean){
  // nur 5/10/15/20 + nach|vor
  // akzeptiert auch "f√ºnf nach", "viertel vor"
  const m = clean.match(/\b(f√ºnf|zehn|viertel|zwanzig)\s+(nach|vor)\b/);
  if(!m) return null;
  const map={f√ºnf:5, zehn:10, viertel:15, zwanzig:20};
  return {delta: map[m[1]], rel: m[2]};
}

function parseBasePhraseToTime(clean){
  // "halb sieben" => 6:30
  // "punkt sechs" => 6:00
  // "f√ºnf nach halb sieben" => 6:35 (aber das w√§re schon direkte L√∂sung)
  const padded = " " + clean + " ";

  // punkt <hour>
  for(const h of HOURS){
    if(padded.includes(" punkt " + h + " ")) {
      const hour = HOURS.indexOf(h)+1;
      return {hour, minute:0};
    }
  }
  // halb <hour> (hour ist "n√§chste stunde" im alltag)
  for(const h of HOURS){
    if(padded.includes(" halb " + h + " ")) {
      const target = HOURS.indexOf(h)+1; // das ist die genannte stunde
      // halb sieben => 6:30
      const baseHour = (target===1)?12:(target-1);
      return {hour: baseHour, minute:30};
    }
  }
  return null;
}

function findDirectPrefixHour(clean){
  // l√§ngste prefix zuerst, damit "f√ºnf vor halb" nicht von "f√ºnf vor" gefressen wird
  const prefixes = [...PREFIXES].sort((a,b)=>b.length-a.length);
  const padded = " " + clean.replace(/\s+/g," ") + " ";

  for(const pref of prefixes){
    for(const h of HOURS){
      const needle = " " + pref + " " + h + " ";
      if(padded.includes(needle)){
        return (pref + " " + h).replace(/\s+/g," ").trim();
      }
    }
  }

  // nur stunde gesagt => punkt stunde
  for(const h of HOURS){
    if(padded.includes(" " + h + " ")){
      return "punkt " + h;
    }
  }
  return "";
}

function extractColloquialFromRaw(raw){
  const clean = normalizeRaw(raw);
  if(!clean) return "";

  // 1) direkte form: "f√ºnf nach halb sieben" usw.
  const direct = findDirectPrefixHour(clean);
  if(direct) return direct;

  // 2) offset + basiszeit (hh:mm)
  // z.B. "f√ºnf nach 06:30"
  const t = parseTimeToken(clean);
  const off = parseOffsetToken(clean);
  if(t && off){
    let total = (t.hour*60 + t.minute) + (off.rel==="nach" ? off.delta : -off.delta);

    // normalisieren
    while(total < 0) total += 12*60;
    total = total % (12*60);

    let hh = Math.floor(total/60);
    let mm = total % 60;
    if(hh===0) hh=12;

    if(SUPPORTED_MINUTES.includes(mm)){
      return timeToColloquial(hh, mm);
    }
  }

  // 3) offset + basisphrase (halb/punkt)
  // z.B. "f√ºnf nach halb sieben"
  // (hier w√§re direct eigentlich schon gefunden ‚Äì aber falls SR auseinander f√§llt)
  if(off){
    const base = parseBasePhraseToTime(clean);
    if(base){
      let total = (base.hour*60 + base.minute) + (off.rel==="nach" ? off.delta : -off.delta);
      while(total < 0) total += 12*60;
      total = total % (12*60);
      let hh = Math.floor(total/60);
      let mm = total % 60;
      if(hh===0) hh=12;
      if(SUPPORTED_MINUTES.includes(mm)){
        return timeToColloquial(hh, mm);
      }
    }
  }

  // 4) nur hh:mm
  if(t && SUPPORTED_MINUTES.includes(t.minute)){
    return timeToColloquial(t.hour, t.minute);
  }

  return "";
}

/* ==========================
   SPEECH
========================== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizer=null, isListening=false;

function setupSpeech(){
  if(!SR){
    micBtn.disabled=true;
    micBtn.textContent="üé§ Nicht verf√ºgbar";
    fallbackWrap.classList.remove("hidden");
    srNote.textContent="Spracherkennung funktioniert am zuverl√§ssigsten in Chrome/Edge.";
    return;
  }
  recognizer = new SR();
  recognizer.lang = "de-DE";
  recognizer.interimResults = false;
  recognizer.continuous = false;
  recognizer.maxAlternatives = 1;

  recognizer.onstart = () => {
    isListening=true;
    micBtn.classList.add("listening");
    micBtn.textContent="‚èπ Stop";
    feedback.textContent="";
    feedback.className="feedback";
    heardUI.textContent="Umgangssprache: ‚Ä¶";
  };
  recognizer.onend = () => {
    isListening=false;
    micBtn.classList.remove("listening");
    micBtn.textContent="üé§ Sprechen";
  };
  recognizer.onerror = (e) => {
    feedback.textContent="Sprach-Fehler: " + (e.error || "unbekannt");
    feedback.className="feedback error";
    fallbackWrap.classList.remove("hidden");
  };
  recognizer.onresult = (e) => {
    const raw = (e.results?.[0]?.[0]?.transcript || "").trim();
    lastColloquial = extractColloquialFromRaw(raw);
    heardUI.textContent = "Umgangssprache: " + (lastColloquial || "‚Äî");
  };

  srNote.textContent="Mikrofon erlauben, dann ‚ÄûSprechen‚Äú klicken. (Chrome/Edge empfohlen)";
}

/* ==========================
   START UI
========================== */
gradeGrid.querySelectorAll(".grade-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const g = Number(btn.dataset.grade);
    selectedGrade = (selectedGrade===g) ? null : g;
    gradeGrid.querySelectorAll(".grade-btn").forEach(b=>b.classList.toggle("selected", Number(b.dataset.grade)===selectedGrade));
    updateStartControls();
  });
});
difficultyGrid.querySelectorAll(".difficulty-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const d = btn.dataset.diff;
    selectedDifficulty = (selectedDifficulty===d) ? null : d;
    difficultyGrid.querySelectorAll(".difficulty-btn").forEach(b=>b.classList.toggle("selected", b.dataset.diff===selectedDifficulty));
    updateStartControls();
  });
});

function updateStartControls(){
  if(!selectedGrade){ selectedInfo.textContent="Bitte eine Klasse ausw√§hlen."; startBtn.disabled=true; return; }
  if(!selectedDifficulty){ selectedInfo.textContent="Bitte eine Schwierigkeit ausw√§hlen."; startBtn.disabled=true; return; }
  selectedInfo.textContent = `Ausgew√§hlt: ${GRADE_LABELS[selectedGrade]}, ${DIFF_LABELS[selectedDifficulty]}`;
  startBtn.disabled = false;
}

startBtn.addEventListener("click", startTraining);

restartBtn.addEventListener("click", ()=>{
  quizScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  startScreen.classList.remove("hidden");
});

finishBtn.addEventListener("click", ()=>{
  finishBtn.disabled=true;
  finishBtn.textContent="Erledigt ‚úî";
  try{
    if(window.parent && window.parent !== window){
      window.parent.postMessage("AppSolved","*");
    }
  }catch(_){}
});

micBtn.addEventListener("click", ()=>{
  if(!recognizer){ fallbackWrap.classList.remove("hidden"); return; }
  if(isListening){ try{ recognizer.stop(); }catch(_){ } return; }
  try{
    lastColloquial="";
    recognizer.start();
  }catch(_){
    feedback.textContent="Bitte kurz warten und nochmals klicken.";
    feedback.className="feedback error";
  }
});

checkBtn.addEventListener("click", checkAnswer);
fallbackInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ e.preventDefault(); checkAnswer(); }
});

/* ==========================
   QUIZ LOGIC
========================== */
function startTraining(){
  questionsDone=0; correctAnswers=0; wrongAnswers=0; usedQuestions=[];
  statCorrect.textContent="0";
  statWrong.textContent="0";
  statTotal.textContent=String(TOTAL_QUESTIONS);
  statMode.textContent=`${GRADE_LABELS[selectedGrade]} ‚Äì ${DIFF_LABELS[selectedDifficulty]}`;

  feedback.textContent="";
  feedback.className="feedback";
  heardUI.textContent="Umgangssprache: ‚Äî";
  expectedHint.textContent="";
  fallbackInput.value="";
  lastColloquial="";

  startScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  quizScreen.classList.remove("hidden");

  newQuestion();
}

function generateQuestion(grade, diff){
  const hour = randomInt(1,12);
  let minute = 0;
  let label = "";

  if(grade===2 && diff==="easy"){
    minute = pick([0,30]);
    label = "Volle & halbe Stunden";
  } else if(grade===2 && diff==="hard"){
    minute = pick([0,5,10,15,20,25,30,35,40,45,50,55]);
    label = "Umgangssprache Mix";
  } else {
    minute = pick(SUPPORTED_MINUTES);
    label = (diff==="easy") ? "5-Minuten-Schritte" : "5-Minuten-Schritte (Mix)";
  }

  const expected = timeToColloquial(hour, minute);
  return {hour, minute, label, expected};
}

function newQuestion(){
  feedback.textContent="";
  feedback.className="feedback";
  heardUI.textContent="Umgangssprache: ‚Äî";
  fallbackInput.value="";
  lastColloquial="";

  let q, tries=0;
  while(true){
    q = generateQuestion(selectedGrade, selectedDifficulty);
    const key = `${q.hour}-${q.minute}-${selectedGrade}-${selectedDifficulty}`;
    if(!usedQuestions.includes(key)){ usedQuestions.push(key); break; }
    if(++tries>500) break;
  }

  currentQuestion = q;
  variantLabel.textContent = q.label;
  drawClock(q.hour, q.minute);
  progressText.textContent = `Aufgabe ${questionsDone+1} von ${TOTAL_QUESTIONS}`;
  expectedHint.textContent = "Beispiel richtig: " + q.expected;
}

function checkAnswer(){
  let spoken = lastColloquial;

  if(!spoken){
    const typed = (fallbackInput.value||"").trim();
    spoken = extractColloquialFromRaw(typed);
    lastColloquial = spoken;
    heardUI.textContent = "Umgangssprache: " + (spoken || "‚Äî");
  }

  if(!spoken){
    feedback.textContent="Kein g√ºltiges Muster gefunden (nur die erlaubten Kombinationen werden gepr√ºft).";
    feedback.className="feedback error";
    return;
  }

  const ok = (spoken === currentQuestion.expected);

  if(ok){
    correctAnswers++;
    statCorrect.textContent=String(correctAnswers);
    feedback.textContent="Richtig! üëç";
    feedback.className="feedback ok";
  } else {
    wrongAnswers++;
    statWrong.textContent=String(wrongAnswers);
    feedback.textContent="Falsch. Richtig w√§re: " + currentQuestion.expected;
    feedback.className="feedback error";
  }

  questionsDone++;
  if(questionsDone>=TOTAL_QUESTIONS) setTimeout(endTraining, 700);
  else setTimeout(newQuestion, 700);
}

function endTraining(){
  quizScreen.classList.add("hidden");
  resultScreen.classList.remove("hidden");
  const quote = (correctAnswers/TOTAL_QUESTIONS*100).toFixed(0);
  resultSummary.innerHTML =
    `Du hast <strong>${TOTAL_QUESTIONS}</strong> Uhrzeiten gel√∂st.<br>`+
    `Richtig: <strong>${correctAnswers}</strong> (${quote}%).<br>`+
    `Falsch: <strong>${wrongAnswers}</strong>.`;
}

/* ==========================
   CLOCK: ticks, no numbers, red hour, blue minute
========================== */
function drawClock(hour, minute){
  const ctx=clockCtx;
  const w=clockCanvas.width, h=clockCanvas.height;
  const r=Math.min(w,h)/2-12;
  const cx=w/2, cy=h/2;

  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.translate(cx,cy);

  // face
  ctx.beginPath();
  ctx.arc(0,0,r,0,Math.PI*2);
  ctx.fillStyle="#ffffff";
  ctx.fill();
  ctx.lineWidth=3;
  ctx.strokeStyle="#111827";
  ctx.stroke();

  // ticks 60
  for(let i=0;i<60;i++){
    const a=(Math.PI/30)*i - Math.PI/2;
    const isHour=(i%5===0);
    const outer=r-6;
    const inner=r-(isHour?20:12);
    ctx.beginPath();
    ctx.moveTo(inner*Math.cos(a), inner*Math.sin(a));
    ctx.lineTo(outer*Math.cos(a), outer*Math.sin(a));
    ctx.lineWidth=isHour?3:1.2;
    ctx.strokeStyle="#111827";
    ctx.stroke();
  }

  // minute hand (blue)
  const ma=(Math.PI/30)*minute - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo((r-24)*Math.cos(ma), (r-24)*Math.sin(ma));
  ctx.lineWidth=4;
  ctx.strokeStyle="#2563eb";
  ctx.lineCap="round";
  ctx.stroke();

  // hour hand (red)
  const ha=(Math.PI/6)*((hour%12)+minute/60) - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo((r-62)*Math.cos(ha), (r-62)*Math.sin(ha));
  ctx.lineWidth=5;
  ctx.strokeStyle="#dc2626";
  ctx.lineCap="round";
  ctx.stroke();

  // center
  ctx.beginPath();
  ctx.arc(0,0,5,0,Math.PI*2);
  ctx.fillStyle="#111827";
  ctx.fill();

  ctx.restore();
}

/* ==========================
   INIT
========================== */
(function init(){
  statTotal.textContent=String(TOTAL_QUESTIONS);
  drawClock(12,0);
  setupSpeech();
  updateStartControls();
})();
</script>
</body>
</html>
